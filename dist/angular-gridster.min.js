/*
 * angular-gridster
 * http://manifestwebdesign.github.io/angular-gridster
 *
 * @version: 0.9.8
 * @license: MIT
 */
"use strict";angular.module("gridster",[]).constant("gridsterConfig",{columns:6,width:"auto",colWidth:"auto",rowHeight:"match",margins:[10,10],isMobile:!1,minColumns:1,minRows:1,maxRows:100,defaultSizeX:2,defaultSizeY:1,mobileBreakPoint:600,resizable:{enabled:!0},draggable:{enabled:!0}}).controller("GridsterCtrl",["$scope","gridsterConfig",function(a,b){this.options=angular.extend({},b),this.grid=[],this.$preview=null,this.$element=null,this.init=function(a,b){this.$element=a,this.$preview=b},this.destroy=function(){this.options=this.options.margins=this.grid=this.$element=this.$preview=null},this.setOptions=function(){$.extend(!0,this.options,a.config),this.options.curWidth="auto"===this.options.width?this.$element.width():this.options.width,this.options.curColWidth="auto"===this.options.colWidth?(this.options.curWidth-this.options.margins[1])/this.options.columns:this.options.colWidth,this.options.curRowHeight="match"===this.options.rowHeight?this.options.curColWidth:this.options.rowHeight},this.redraw=function(){this.setOptions(),this.options.isMobile=this.options.curWidth<=this.options.mobileBreakPoint;for(var a=0,b=this.grid.length;b>a;++a){var c=this.grid[a];if(c)for(var d=0,e=c.length;e>d;++d)if(c[d]){var f=c[d],g=f.$element;this.setElementPosition(g,f.row,f.col),this.setElementSizeY(g,f.sizeY),this.setElementSizeX(g,f.sizeX)}}},this.canItemOccupy=function(a,b,c){return b>-1&&c>-1&&a.sizeX+c<=this.options.columns},this.autoSetItemPosition=function(a){for(var b=0;b<this.options.maxRows;++b)for(var c=0;c<this.options.columns;++c)if(!this.getItem(b,c)&&this.canItemOccupy(a,b,c))return void this.putItem(a,b,c);throw new Error("Unable to place item!")},this.getItems=function(a,b,c,d,e){var f=[];c&&d||(c=d=1),!e||e instanceof Array||(e=[e]);for(var g=0;d>g;++g)for(var h=0;c>h;++h){var i=this.getItem(a+g,b+h,e);!i||e&&-1!==e.indexOf(i)||-1!==f.indexOf(i)||f.push(i)}return f},this.removeItem=function(a){for(var b=0,c=this.grid.length;c>b;++b){var d=this.grid[b];if(d){var e=d.indexOf(a);if(-1!==e){d[e]=null;break}}}this.floatItemsUp(),this.updateHeight()},this.getItem=function(a,b,c){!c||c instanceof Array||(c=[c]);for(var d=1;a>-1;){for(var e=1,f=b;f>-1;){var g=this.grid[a];if(g){var h=g[f];if(h&&(!c||-1===c.indexOf(h))&&h.sizeX>=e&&h.sizeY>=d)return h}++e,--f}--a,++d}return null},this.putItems=function(a){for(var b=0,c=a.length;c>b;++b)this.putItem(a[b])},this.putItem=function(a,b,c){if(("undefined"==typeof b||null===b)&&(b=a.row,c=a.col,"undefined"==typeof b||null===b))return void this.autoSetItemPosition(a);if(this.canItemOccupy(a,b,c)||(c=Math.min(this.options.columns-a.sizeX,Math.max(0,c)),b=Math.max(0,b)),a&&null!==a.oldRow&&"undefined"!=typeof a.oldRow){if(a.oldRow===b&&a.oldColumn===c)return a.row=b,void(a.col=c);var d=this.grid[a.oldRow];d&&d[a.oldColumn]===a&&delete d[a.oldColumn]}a.oldRow=a.row=b,a.oldColumn=a.col=c,this.moveOverlappingItems(a),this.grid[b]||(this.grid[b]=[]),this.grid[b][c]=a},this.moveOverlappingItems=function(a){var b=this.getItems(a.row,a.col,a.sizeX,a.sizeY,a);this.moveItemsDown(b,a.row+a.sizeY)},this.moveItemsDown=function(a,b){if(a&&0!==a.length){var c,d,e,f={};for(d=0,e=a.length;e>d;++d){c=a[d];var g=f[c.col];("undefined"==typeof g||c.row<g)&&(f[c.col]=c.row)}for(d=0,e=a.length;e>d;++d){c=a[d];var h=b-f[c.col];this.putItem(c,c.row+h,c.col)}}},this.floatItemsUp=function(){for(var a=0,b=this.grid.length;b>a;++a){var c=this.grid[a];if(c)for(var d=0,e=c.length;e>d;++d)c[d]&&this.floatItemUp(c[d])}},this.floatItemUp=function(a){for(var b=a.col,c=a.sizeY,d=a.sizeX,e=null,f=null,g=a.row-1;g>-1;){var h=this.getItems(g,b,d,c,a);if(0!==h.length)break;e=g,f=b,--g}null!==e&&this.putItem(a,e,f)},this.updateHeight=function(a){var b=this.options.minRows;a||(a=0);for(var c=this.grid.length;c>=0;--c){var d=this.grid[c];if(d)for(var e=0,f=d.length;f>e;++e)d[e]&&(b=Math.max(b,c+a+d[e].sizeY))}this.options.gridHeight=Math.min(this.options.maxRows,b)},this.pixelsToRows=function(a,b){return b===!0?Math.ceil(a/this.options.curRowHeight):b===!1?Math.floor(a/this.options.curRowHeight):Math.round(a/this.options.curRowHeight)},this.pixelsToColumns=function(a,b){return b===!0?Math.ceil(a/this.options.curColWidth):b===!1?Math.floor(a/this.options.curColWidth):Math.round(a/this.options.curColWidth)},this.setElementPosition=function(a,b,c){a.css(this.options.isMobile?{margin:this.options.margins[0]+"px",top:"auto",left:"auto"}:{margin:0,top:b*this.options.curRowHeight+this.options.margins[0],left:c*this.options.curColWidth+this.options.margins[1]})},this.setElementSizeY=function(a,b){this.options.isMobile?a.css("height","auto"):a.css("height",b*this.options.curRowHeight-this.options.margins[0]+"px")},this.setElementSizeX=function(a,b){this.options.isMobile?a.css("width","auto"):a.css("width",b*this.options.curColWidth-this.options.margins[1]+"px")}}]).directive("gridster",["$parse","$timeout","$rootScope",function(a,b,c){return{restrict:"EAC",controller:"GridsterCtrl",scope:{config:"=?gridster"},compile:function(a){return a.addClass("gridster"),function(a,b,d,e){var f=angular.element('<div class="gridster-item gridster-preview-holder"></div>').appendTo(b);a.$watch("config",function(a,b){a&&a!==b&&(e.setOptions(),"undefined"!=typeof a.draggable&&a.draggable.enabled&&c.$broadcast("draggable-changed"),"undefined"!=typeof a.resizable&&a.resizable.enabled&&c.$broadcast("resizable-changed"))},!0),e.init(b,f),e.setOptions()}}}}]).controller("GridsterItemCtrl",function(){this.$element=null,this.gridster=null,this.dragging=!1,this.resizing=!1,this.row=null,this.col=null,this.sizeX=null,this.sizeY=null,this.init=function(a,b){this.$element=a,this.gridster=b,this.sizeX=b.options.defaultSizeX,this.sizeY=b.options.defaultSizeY},this.destroy=function(){this.gridster=null,this.$element=null},this.toJSON=function(){return{row:this.row,col:this.col,sizeY:this.sizeY,sizeX:this.sizeX}},this.setPosition=function(a,b){this.gridster.putItem(this,a,b),this.gridster.floatItemsUp(),this.gridster.updateHeight(this.dragging?this.sizeY:0),this.dragging?this.gridster.setElementPosition(this.gridster.$preview,this.row,this.col):this.gridster.setElementPosition(this.$element,this.row,this.col)},this.setSize=function(a,b){a=a.toUpperCase();var c="size"+a,d="Size"+a;if(""!==b){b=parseInt(b,10),(isNaN(b)||0===b)&&(b=this.gridster.options["default"+d]);var e=!(this[c]===b&&this["old"+d]&&this["old"+d]===b);this["old"+d]=this[c]=b,this.resizing?(this.gridster.setElementPosition(this.gridster.$preview,this.row,this.col),this.gridster["setElement"+d](this.gridster.$preview,b)):this.gridster["setElement"+d](this.$element,b),e&&(this.gridster.moveOverlappingItems(this),this.gridster.floatItemsUp(),this.gridster.updateHeight(this.dragging?this.sizeY:0))}},this.setSizeY=function(a){this.setSize("y",a)},this.setSizeX=function(a){this.setSize("x",a)}}).directive("gridsterItem",["$parse","$controller","$timeout",function(){return{restrict:"EAC",require:"^gridster",link:function(a,b,c,d){b.resizable({autoHide:!0,handles:"n, e, s, w, ne, se, sw, nw",start:function(c,e){a.$apply(function(){d.options.resizable&&d.options.resizable.start&&d.options.resizable.start(c,e,b)})},resize:function(c,e){a.$apply(function(){d.options.resizable&&d.options.resizable.resize&&d.options.resizable.resize(c,e,b)})},stop:function(c,e){a.$apply(function(){d.options.resizable&&d.options.resizable.stop&&d.options.resizable.stop(c,e,b)})}})}}}]);